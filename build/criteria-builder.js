Ext.define("CriteriaBuilder.mixin.SQLParser",{extend:"Ext.Mixin",mixinId:"sqlparser",fieldRegex:/^select\s(.*?)(?=where|join|order\sby$)/gi,joinRegex:/join.*?(?=where|join|$)/gi,criteriaRegex:/where\s.*?(?=order\sby|$)/gi,orderRegex:/\sorder\sby\s.*?(?=limit\s|$)/gi,limitRegex:/\slimit\s[1-9]+((,|,\s)[1-9]+)?$/gi,operatorRegex:/=|!=|<=|<|>=|>|like|not\slike|between|not\sbetween|is\snull|is\snot\snull/gi,likeRegex:/like|not\slike/i,betweenRegex:/between|not\sbetween/i,nullRegex:/is\snull|is\snots\null/,andOrRegex:/\sand\s|\sor\s/i,determineFields:function(f){var e={},a=f.match(this.fieldRegex),j=a.length?a[0].replace(/^select\s/i,"").split(","):[],b,d,g,h,c;for(c=0;c<j.length;c++){b=Ext.String.trim(j[c]).split(/\s/);d=b[0].split(".");h=d.length>1?d[1]:d[0];g=b.length>1?b[1]:h;this.addColumn(b[0],g)}},determineJoins:function(f){var h={},c=f.match(this.joinRegex),e,g,d,a,b;for(b=0;b<c.length;b++){a=Ext.String.trim(c[b]);g=a.split(" ");d=g[2]||g[1].toLowerCase(),e=g[2]||g[1].toLowerCase();this.addJoin(g[1],e,g[4])}},determineCriteria:function(m){var n=[],e=this.criteriaRegex,g=this.operatorRegex,a=m.match(e),h,l,b,d,j,p,o,c,f,k;if(a.length){h=a[0].replace(/where\s/gi,"");d=h.split(this.andOrRegex);for(c=0;c<d.length;c++){o=Ext.String.trim(d[c]);l=o.split(g);b=l[0].split(".");j=b.length>1?l[0]:this.rootEntity+"."+l[0];p=o.match(g);if(p){this.addCriteria(Ext.String.trim(j),Ext.String.trim(l[1]),p[0],this.determineCriteriaType(p[0]))}else{if(/{{.*}}/.test(o)){f=o.replace(/{|}/g,"");if(this.customCriteriaCache[f]){this.addCriteria(null,null,f,"custom")}else{}}}}}},determineOrder:function(f){var a=[],e=this.orderRegex,d=f.match(e),c,b;for(b=0;b<d.length;b++){c=Ext.String.trim(d[b]).split(/\s/);if(c.length==4&&/ASC|DESC/i.test(c[3])){this.addOrder(c[2],c[3])}}},determineLimit:function(e){var a=0,f=0,d=this.limitRegex,b=e.match(d),c;if(b&&b.length){c=b[0].match(/[1-9]+/g);this.max=parseInt(c[0])||a;this.offset=parseInt(c[1])||f}},determineCriteriaType:function(a){var b;if(this.nullRegex.test(a)){return"null"}if(this.likeRegex.test(a)){return"like"}if(this.betweenRegex.test(a)){return"between"}return"compare"}});Ext.define("CriteriaBuilder.mixin.DSL",{extend:"Ext.Mixin",mixinId:"dsl",columns:function(e){var d,f,a,b,c;for(d in e){f=e[d];a=Ext.isArray(f);b=a?f[0]:f.column;c=a?f[1]:f.alias;if(b){this.addColumn(b,c||null)}}return this},column:function(a,b){this.addColumn(a,b);return this},join:function(a,b,c){this.addJoin(a,b,c);return this},order:function(a,b){this.addOrder(a,b);return this},limit:function(a,b){this.max=a||0;this.offset=b||0;return this},between:function(a,b,c){this.addCriteria(a,[b,c].join(","),"between","between");return this},notbetween:function(a,b,c){this.addCriteria(a,[b,c].join(","),"not between","between");return this},like:function(a,b){this.addCriteria(a,b,"like","like");return this},notlike:function(a,b){this.addCriteria(a,b,"not like","like");return this},eq:function(a,b){this.addCriteria(a,b,"=","compare");return this},neq:function(a,b){this.addCriteria(a,b,"!=","compare");return this},lt:function(a,b){this.addCriteria(a,b,"<","compare");return this},lte:function(a,b){this.addCriteria(a,b,"<=","compare");return this},gt:function(a,b){this.addCriteria(a,b,">","compare");return this},gte:function(a,b){this.addCriteria(a,b,">=","compare");return this},isNull:function(a){this.addCriteria(a,null,"is null","null");return this},isNotNull:function(a){this.addCriteria(a,null,"is not null","null");return this},customCriteria:function(a,b){this.customCriteriaCache[a]=b;this.addCriteria(null,null,a,"custom");return this}});Ext.define("CriteriaBuilder.QueryBuilder",{extend:"Ext.Base",mixins:["CriteriaBuilder.mixin.SQLParser","CriteriaBuilder.mixin.DSL"],config:{store:null},rootEntity:"_this",fields:{},joins:{},criteria:[],sorters:[],max:0,offset:0,joinMap:{},customCriteriaCache:{},fieldTypeMappings:{},operatorMap:{"=":"findEQ","!=":"findNEQ","<":"findLT","<=":"findLTE",">":"findGT",">=":"findGTE",like:"findLike","not like":"findNotLike",between:"findBetween","not between":"findNotBetween","is null":"findIsNull","is not null":"findIsNotNull"},constructor:function(a){this.initConfig(a);this.joinMap[this.rootEntity]=this.rootEntity;this.determineFieldTypes();return this},createFieldTypeMap:function(a,c,b){var d=this;Ext.Object.each(a.getFieldsMap(),function(e,f,g){d.fieldTypeMappings[c+"."+e]=b=="right"?f.getType():"auto"})},addColumn:function(a,b){var e=a.split("."),c=e.length>1?e[1]:e[0],d=e.length>1?e[0]:this.rootEntity;this.fields[d+"."+c]={name:c,alias:b||a}},addJoin:function(a,b,d){var c=b||a;this.joins[b||a]={association:a,alias:c,owner:d};this.joinMap[a]=c},addCriteria:function(g,f,c,e){var b=g,a=b&&g.split(".").length>1,d=/([\"'])(?:\\\1|.)*?\1/.test(f)?f.replace(/^["'](.*)["']$/,"$1"):f;this.criteria.push({property:!a&&b?this.rootEntity+"."+g:g,value:d,operator:c,type:e})},addOrder:function(a,b){this.sorters.push({property:a,direction:b.toUpperCase()})},determineRange:function(b){var c=this.offset,a=b.getCount()-1;if(this.max){a=Math.min((c+(this.max-1)),a)}return[c,a]},determineFieldTypes:function(){var c=this,b=this.getStore().getModel().schema,d,a,e;this.createFieldTypeMap(this.getStore().getModel(),this.rootEntity);b.eachAssociation(function(g,f){d=f.left;a=f.right;if(d&&d.cls){e=d.role;c.createFieldTypeMap(d.cls,e,"left")}if(a&&a.cls){e=a.role;c.createFieldTypeMap(a.cls,e,"right")}})},getFlattenedData:function(d,a,c,h){var b=this,f=this.joinMap[c],g,e;if(Ext.isObject(a)){Ext.Object.each(a,function(i,j,k){g="";if(f){if(!Ext.isObject(j)&&!Ext.isArray(j)){g=h!==undefined?f+"."+h:f;e=g+"."+i;d[e]=j}else{b.getFlattenedData(d,a[i],i)}}})}if(Ext.isArray(a)){Ext.Array.each(a,function(k,j,i){b.getFlattenedData(d,k,c,j)})}return d},findMatchingKeys:function(e,d){if(!e){return[]}var c=[],a=e.split("."),b=new RegExp("^"+a[0]+"(.[0-9]+)?."+a[1]+"$");Ext.Object.each(d,function(f,g,h){if(b.test(f)){c.push(f)}});return c},pruneData:function(d){var e=this.fields,c={},a=/^\w+\.\d+\.\w+$/i,f=/(^\w+)(\.\d+)(\.\w+$)/i,b;Ext.Object.each(d,function(g,h,i){b=a.test(g);g=b?g.replace(f,"$1$3"):g;if(e.hasOwnProperty(g)){if(!b){c[e[g].alias]=h}else{if(!Ext.isArray(c[e[g].alias])){c[e[g].alias]=[]}c[e[g].alias].push(h)}}});return c},getFieldsForStore:function(){var g=this.fields,b,e=[],d,f,c,a;for(b in g){d=b.split(".")[0];f=this.joins[d];c=f?f.association:this.rootEntity;a=this.fieldTypeMappings[c+"."+g[b].name];e.push({name:g[b].alias,type:a||"auto"})}return e},createStore:function(f){var e=this,a=e.getFieldsForStore(),c=new Ext.data.Store({fields:a,sorters:this.sorters}),b=[],d;f.each(function(i,h,g){d=e.pruneData(i);b.push(d)});c.add(b);return c},prepareCollection:function(d){var b=this,c=this.createCollection(),a;d.each(function(g,f,e){a=b.pruneData(g);c.add(g.$id,a)});return c},rangeCollection:function(b){var a=this.determineRange(b);if(a[0]>0||a[1]){b.each(function(e,d,c){if(d<a[0]||d>a[1]){b.remove(e)}})}return b},filterAndSortStoreByCollection:function(c){var a=this.getStore(),b=c.keys;a.filterBy(function(d,e){return Ext.Array.contains(b,d.getId())});a.sort({sorterFn:function(e,d){var g=c.indexOfKey(e.getId()),f=c.indexOfKey(d.getId());return g>f?1:(g===f)?0:-1}})},parseQueryString:function(a){this.determineFields(a);this.determineJoins(a);this.determineCriteria(a);this.determineOrder(a);this.determineLimit(a)},createCollection:function(){return new Ext.util.MixedCollection({getKey:function(a){return a.$id}})},processCriteria:function(l){var r=this,n=[],a=true,j={},o,h,q,d,e,t,p,c,g,k,f,b,m,s=false;l.each(function(v,u,i){a=true;for(h in r.criteria){q=r.criteria[h];t=r.operatorMap[q.operator];k=r.findMatchingKeys(q.property,v);s=k.length>1;b=0;for(o in k){f=k[o];if(v.hasOwnProperty(f)){p=v[f];switch(q.type){case"null":m=r[t](p);break;case"compare":g=Ext.isDate(p)?Ext.Date.parse(q.value,"Y-m-d"):q.value;if(q.operator=="="||q.operator=="!="){d=j["eq"+f]=j["eq_"+f]||r.buildEqRegex(q.value);c=[p,d]}else{c=[p,g]}break;case"like":d=j["like_"+f]=j["like_"+f]||r.buildLikeRegex(q.value);c=[p,d];break;case"between":range=j["between_"+f]=j["between_"+f]||r.buildBetweenRange(q.value);c=[p,range[0],range[1]];break}m=r[t].apply(this,c);if(m){b++}}}if(q.type=="custom"){m=r.customCriteriaCache[q.operator](v);if(m){b++}}if(s){a=b>=1}else{a=b}if(!a){l.remove(v);break}}});return l},buildBetweenRange:function(d){var b=d.split(","),c=b[0]?Ext.String.trim(b[0]):0,a=b[1]?Ext.String.trim(b[1]):0;return[c,a]},buildLikeRegex:function(d){var c=d.charAt(0)=="%"?"":"^",b=d.charAt(d.length-1)=="%"?"":"$",a=c+d.replace(/%/g,"")+b;return new RegExp(a,"gi")},buildEqRegex:function(a){return Ext.String.createRegex(a,false,true,true)},findIsNull:function(a){return Ext.isEmpty(a)},findIsNotNull:function(a){return !Ext.isEmpty(a)},findBetween:function(c,b,a){var b=!Ext.isDate(b)?Ext.Date.parse(b,"Y-m-d"):b,a=!Ext.isDate(a)?Ext.Date.parse(a,"Y-m-d"):a;console.log(b,a,c);return c>=b&&c<=a},findNotBetween:function(c,b,a){var b=!Ext.isDate(b)?Ext.Date.parse(b,"Y-m-d"):b,a=!Ext.isDate(a)?Ext.Date.parse(a,"Y-m-d"):a;return c<b||c>a},findLike:function(b,a){return a.test(b)},findNotLike:function(b,a){return !a.test(b)},findEQ:function(b,a){return a.test(b)},findNEQ:function(b,a){return !a.test(b)},findLT:function(b,a){return b<a},findLTE:function(b,a){return b<=a},findGT:function(b,a){return b>a},findGTE:function(b,a){return b>=a},query:function(j){var j=Ext.isObject(j)?j:{},g=j.sql||null,h=j.type||"store",e=this.createCollection(),a=this.getStore().getRange(),b,c,d,f;if(g){this.parseQueryString(g)}for(b=0;b<a.length;b++){d=a[b];f=this.getFlattenedData({},d.getData(true),this.rootEntity);f["$id"]=d.getId();e.add(f["$id"],f)}this.processCriteria(e);if(this.sorters.length){e.sort(this.sorters)}this.rangeCollection(e);switch(h){case"collection":return this.prepareCollection(e);case"filter":this.filterAndSortStoreByCollection(e);return this.getStore().getRange();case"store":return this.createStore(e)}}});